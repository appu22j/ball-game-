<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Candy Match Saga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: radial-gradient(circle, #6a11cb 0%, #2575fc 100%);
            touch-action: none;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .candy-font { font-family: 'Fredoka One', cursive; }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 9/16;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 6px;
            padding: 12px;
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            margin: 12px;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        .cell {
            position: relative;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .candy {
            width: 95%;
            height: 95%;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            user-select: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .candy.selected {
            transform: scale(1.15) rotate(5deg);
            filter: brightness(1.2) drop-shadow(0 0 15px #fff);
            z-index: 20;
        }

        .candy.hint {
            animation: pulse-glow 1s infinite alternate;
        }

        @keyframes pulse-glow {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.1); filter: brightness(1.4); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            z-index: 30;
            box-shadow: 0 0 10px currentColor;
        }

        #overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 7, 34, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; }

        .progress-bar {
            height: 16px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f2fe, #4facfe);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 10px #4facfe;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- Header -->
        <div class="p-6 flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <div class="stat-card">
                    <span class="text-[10px] uppercase font-bold text-blue-200 block tracking-wider">Score</span>
                    <span id="score" class="candy-font text-2xl text-white">0</span>
                </div>
                <div class="text-center">
                    <span class="text-[10px] uppercase font-bold text-purple-200 block tracking-wider">Level</span>
                    <span id="level-num" class="candy-font text-4xl text-white drop-shadow-md">1</span>
                </div>
                <div class="stat-card text-right">
                    <span class="text-[10px] uppercase font-bold text-pink-200 block tracking-wider">Moves</span>
                    <span id="moves" class="candy-font text-2xl text-white">20</span>
                </div>
            </div>
            
            <div class="px-2">
                <div class="flex justify-between text-xs font-bold text-white mb-2">
                    <span class="opacity-80">GOAL: <span id="goal-text">1000</span></span>
                    <span id="percentage-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="grid"></div>

        <!-- Footer -->
        <div class="p-6 flex justify-around">
            <button onclick="restartGame()" class="p-3 bg-white/10 rounded-2xl hover:bg-white/20 transition-all border border-white/20 shadow-lg group">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white group-active:rotate-180 transition-transform duration-500"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
        </div>

        <!-- Overlays -->
        <div id="overlay" class="hidden">
            <h2 id="overlay-title" class="candy-font text-5xl mb-4 text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-orange-600">Level Complete!</h2>
            <p id="overlay-msg" class="text-xl mb-8 font-light tracking-wide opacity-90">Sweet!</p>
            <button id="overlay-btn" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-300 hover:to-orange-400 text-white candy-font text-2xl px-12 py-4 rounded-full shadow-2xl transform active:scale-95 transition-all border-b-4 border-orange-700">
                Next Level
            </button>
        </div>
    </div>

    <script>
        const GRID_SIZE = 8;
        const CANDY_TYPES = 6;
        const CANDY_COLORS = ['#FF3B30', '#4CD964', '#007AFF', '#FFCC00', '#AF52DE', '#FF9500'];

        // High Quality Candy SVGs
        const CANDY_SVGS = [
            // Red Strawberry/Heart
            `<svg viewBox="0 0 100 100">
                <defs>
                    <radialGradient id="r1" cx="35%" cy="35%" r="60%">
                        <stop offset="0%" style="stop-color:#FF6B6B" />
                        <stop offset="100%" style="stop-color:#C92A2A" />
                    </radialGradient>
                    <filter id="f1"><feGaussianBlur in="SourceAlpha" stdDeviation="2"/><feOffset dx="1" dy="1"/></filter>
                </defs>
                <path d="M50 85 C50 85 15 60 15 35 A20 20 0 0 1 50 25 A20 20 0 0 1 85 35 C85 60 50 85 50 85Z" fill="url(#r1)" stroke="#800000" stroke-width="2"/>
                <circle cx="35" cy="35" r="8" fill="white" fill-opacity="0.4" filter="url(#f1)"/>
                <path d="M30 65 Q50 75 70 65" stroke="white" stroke-width="3" fill="none" stroke-linecap="round" opacity="0.2"/>
            </svg>`,
            // Green Jelly Cube
            `<svg viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#B2F2BB" />
                        <stop offset="100%" style="stop-color:#2B8A3E" />
                    </linearGradient>
                </defs>
                <rect x="20" y="20" width="60" height="60" rx="12" fill="url(#g1)" stroke="#1a5225" stroke-width="2"/>
                <path d="M20 32 Q50 20 80 32" fill="none" stroke="white" stroke-width="4" opacity="0.3"/>
                <rect x="30" y="30" width="15" height="15" rx="4" fill="white" opacity="0.2"/>
            </svg>`,
            // Blue Sparkling Gem
            `<svg viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="b1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#74C0FC" />
                        <stop offset="100%" style="stop-color:#1864AB" />
                    </linearGradient>
                </defs>
                <path d="M50 15 L85 50 L50 85 L15 50 Z" fill="url(#b1)" stroke="#0b3d66" stroke-width="2"/>
                <path d="M50 15 L50 85 M15 50 L85 50" stroke="white" stroke-width="1" opacity="0.3"/>
                <path d="M30 30 L40 40" stroke="white" stroke-width="4" stroke-linecap="round" opacity="0.5"/>
            </svg>`,
            // Yellow Lemon Drop
            `<svg viewBox="0 0 100 100">
                <defs>
                    <radialGradient id="y1">
                        <stop offset="0%" style="stop-color:#FFF3BF" />
                        <stop offset="100%" style="stop-color:#F59F00" />
                    </radialGradient>
                </defs>
                <ellipse cx="50" cy="50" rx="42" ry="32" fill="url(#y1)" stroke="#9c6600" stroke-width="2"/>
                <path d="M25 50 Q50 35 75 50" stroke="white" stroke-width="5" fill="none" stroke-linecap="round" opacity="0.4"/>
                <circle cx="70" cy="40" r="5" fill="white" opacity="0.3"/>
            </svg>`,
            // Purple Royal Grape
            `<svg viewBox="0 0 100 100">
                <defs>
                    <radialGradient id="p1">
                        <stop offset="0%" style="stop-color:#E599F7" />
                        <stop offset="100%" style="stop-color:#7048E8" />
                    </radialGradient>
                </defs>
                <path d="M50 15 Q85 15 85 50 Q85 85 50 85 Q15 85 15 50 Q15 15 50 15" fill="url(#p1)" stroke="#3b22a1" stroke-width="2"/>
                <path d="M35 30 A15 15 0 0 1 50 20" stroke="white" stroke-width="5" fill="none" stroke-linecap="round" opacity="0.5"/>
                <circle cx="65" cy="65" r="10" fill="white" opacity="0.1"/>
            </svg>`,
            // Orange Tangy Swirl
            `<svg viewBox="0 0 100 100">
                <defs>
                    <radialGradient id="o1">
                        <stop offset="0%" style="stop-color:#FFD8A8" />
                        <stop offset="100%" style="stop-color:#D9480F" />
                    </radialGradient>
                </defs>
                <circle cx="50" cy="50" r="40" fill="url(#o1)" stroke="#862e0b" stroke-width="2"/>
                <path d="M50 25 A25 25 0 0 1 75 50 A25 25 0 0 1 50 75 A25 25 0 0 1 25 50" fill="none" stroke="white" stroke-width="3" opacity="0.3" stroke-dasharray="10 5"/>
                <circle cx="40" cy="40" r="6" fill="white" opacity="0.4"/>
            </svg>`
        ];

        let state = {
            grid: [],
            score: 0,
            moves: 20,
            level: 1,
            goal: 1000,
            selectedCandy: null,
            isProcessing: false
        };

        const gridEl = document.getElementById('grid');
        const scoreEl = document.getElementById('score');
        const movesEl = document.getElementById('moves');
        const levelEl = document.getElementById('level-num');
        const goalEl = document.getElementById('goal-text');
        const progressEl = document.getElementById('progress-fill');
        const percentageEl = document.getElementById('percentage-text');
        const overlay = document.getElementById('overlay');

        function initGame() {
            state.score = 0;
            state.moves = 20 + (state.level * 2);
            state.goal = state.level * 2500;
            updateUI();
            createGrid();
            overlay.classList.add('hidden');
        }

        function createGrid() {
            gridEl.innerHTML = '';
            state.grid = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                state.grid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    let type;
                    do {
                        type = Math.floor(Math.random() * CANDY_TYPES);
                    } while (
                        (c > 1 && state.grid[r][c - 1].type === type && state.grid[r][c - 2].type === type) ||
                        (r > 1 && state.grid[r - 1][c].type === type && state.grid[r - 2][c].type === type)
                    );
                    
                    const candyObj = { r, c, type, el: null };
                    state.grid[r][c] = candyObj;
                    renderCandy(candyObj);
                }
            }
        }

        function renderCandy(candy) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.r = candy.r;
            cell.dataset.c = candy.c;

            const candyDiv = document.createElement('div');
            candyDiv.className = 'candy';
            candyDiv.innerHTML = CANDY_SVGS[candy.type];
            
            const handleAction = (e) => {
                e.preventDefault();
                handleCandyClick(candy, candyDiv);
            };

            candyDiv.onclick = handleAction;
            candyDiv.ontouchstart = handleAction;

            cell.appendChild(candyDiv);
            gridEl.appendChild(cell);
            candy.el = candyDiv;
        }

        async function handleCandyClick(candy, el) {
            if (state.isProcessing || state.moves <= 0) return;

            if (!state.selectedCandy) {
                state.selectedCandy = { candy, el };
                el.classList.add('selected');
            } else {
                const prev = state.selectedCandy;
                const isNeighbor = Math.abs(prev.candy.r - candy.r) + Math.abs(prev.candy.c - candy.c) === 1;

                if (isNeighbor) {
                    prev.el.classList.remove('selected');
                    state.selectedCandy = null;
                    await swapCandies(prev.candy, candy);
                } else {
                    prev.el.classList.remove('selected');
                    state.selectedCandy = { candy, el };
                    el.classList.add('selected');
                }
            }
        }

        async function swapCandies(c1, c2, checkMatch = true) {
            state.isProcessing = true;
            
            const dR = c2.r - c1.r;
            const dC = c2.c - c1.c;
            
            const anim1 = c1.el.animate([
                { transform: `translate(${dC * 100}%, ${dR * 100}%) scale(1.1)` },
                { transform: `translate(${dC * 100}%, ${dR * 100}%) scale(1)` }
            ], { duration: 300, easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' });

            const anim2 = c2.el.animate([
                { transform: `translate(${-dC * 100}%, ${-dR * 100}%) scale(1.1)` },
                { transform: `translate(${-dC * 100}%, ${-dR * 100}%) scale(1)` }
            ], { duration: 300, easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' });

            await Promise.all([anim1.finished, anim2.finished]);

            const tempType = c1.type;
            c1.type = c2.type;
            c2.type = tempType;
            c1.el.innerHTML = CANDY_SVGS[c1.type];
            c2.el.innerHTML = CANDY_SVGS[c2.type];

            if (checkMatch) {
                const matches = findMatches();
                if (matches.length > 0) {
                    state.moves--;
                    await processMatches();
                } else {
                    await swapCandies(c1, c2, false);
                }
            }
            state.isProcessing = false;
            updateUI();
            checkGameState();
        }

        function findMatches() {
            let matches = new Set();

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE - 2; c++) {
                    let type = state.grid[r][c].type;
                    if (type !== -1 && type === state.grid[r][c+1].type && type === state.grid[r][c+2].type) {
                        matches.add(state.grid[r][c]);
                        matches.add(state.grid[r][c+1]);
                        matches.add(state.grid[r][c+2]);
                    }
                }
            }

            for (let c = 0; c < GRID_SIZE; c++) {
                for (let r = 0; r < GRID_SIZE - 2; r++) {
                    let type = state.grid[r][c].type;
                    if (type !== -1 && type === state.grid[r+1][c].type && type === state.grid[r+2][c].type) {
                        matches.add(state.grid[r][c]);
                        matches.add(state.grid[r+1][c]);
                        matches.add(state.grid[r+2][c]);
                    }
                }
            }

            return Array.from(matches);
        }

        async function processMatches() {
            let matches = findMatches();
            if (matches.length === 0) return;

            state.score += matches.length * 60;
            updateUI();

            const promises = matches.map(c => {
                createParticles(c.el, CANDY_COLORS[c.type]);
                return c.el.animate([
                    { transform: 'scale(1) rotate(0deg)', opacity: 1 },
                    { transform: 'scale(1.5) rotate(90deg)', opacity: 0 }
                ], { duration: 400, easing: 'ease-out' }).finished;
            });

            await Promise.all(promises);
            matches.forEach(c => c.type = -1);
            await refillGrid();
            await processMatches();
        }

        async function refillGrid() {
            for (let c = 0; c < GRID_SIZE; c++) {
                let emptySpots = 0;
                for (let r = GRID_SIZE - 1; r >= 0; r--) {
                    if (state.grid[r][c].type === -1) {
                        emptySpots++;
                    } else if (emptySpots > 0) {
                        const targetR = r + emptySpots;
                        state.grid[targetR][c].type = state.grid[r][c].type;
                        state.grid[r][c].type = -1;
                        state.grid[targetR][c].el.innerHTML = CANDY_SVGS[state.grid[targetR][c].type];
                        state.grid[targetR][c].el.style.opacity = 1;
                    }
                }
                
                for (let r = 0; r < emptySpots; r++) {
                    state.grid[r][c].type = Math.floor(Math.random() * CANDY_TYPES);
                    state.grid[r][c].el.innerHTML = CANDY_SVGS[state.grid[r][c].type];
                    state.grid[r][c].el.style.opacity = 1;
                    state.grid[r][c].el.animate([
                        { transform: 'translateY(-300%) scale(0.5)', opacity: 0 },
                        { transform: 'translateY(0) scale(1)', opacity: 1 }
                    ], { duration: 500, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });
                }
            }
            await new Promise(r => setTimeout(r, 550));
        }

        function createParticles(el, color) {
            const rect = el.getBoundingClientRect();
            const containerRect = gridEl.getBoundingClientRect();
            
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = (4 + Math.random() * 6) + 'px';
                p.style.height = p.style.width;
                p.style.backgroundColor = color;
                p.style.color = color;
                p.style.left = (rect.left - containerRect.left + rect.width/2) + 'px';
                p.style.top = (rect.top - containerRect.top + rect.height/2) + 'px';
                gridEl.appendChild(p);

                const angle = Math.random() * Math.PI * 2;
                const velocity = 8 + Math.random() * 10;
                const tx = Math.cos(angle) * 120;
                const ty = Math.sin(angle) * 120;

                p.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 800, easing: 'ease-out' }).onfinish = () => p.remove();
            }
        }

        function updateUI() {
            scoreEl.innerText = state.score;
            movesEl.innerText = state.moves;
            levelEl.innerText = state.level;
            goalEl.innerText = state.goal;
            const progress = Math.min((state.score / state.goal) * 100, 100);
            progressEl.style.width = progress + '%';
            percentageEl.innerText = Math.floor(progress) + '%';
        }

        function checkGameState() {
            if (state.score >= state.goal) {
                showOverlay("Level Complete!", "Tastetastic!", "Next Level", () => {
                    state.level++;
                    initGame();
                });
            } else if (state.moves <= 0) {
                showOverlay("Out of Moves!", "So Close!", "Retry Level", () => {
                    initGame();
                });
            }
        }

        function showOverlay(title, msg, btnText, callback) {
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay-msg').innerText = msg;
            const btn = document.getElementById('overlay-btn');
            btn.innerText = btnText;
            btn.onclick = callback;
            overlay.classList.remove('hidden');
        }

        function restartGame() {
            state.level = 1;
            initGame();
        }

        window.onload = initGame;
    </script>
</body>
</html>
